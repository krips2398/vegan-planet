--- 
title: "Plant-Based Dining Trends"
author: "Sai Krupa Jangala, Kailande Cassamajor"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction


<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources


<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation

<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values

```{r}
library(dplyr)
library(naniar)
library(mi)
library(ggplot2)
library(forcats)
library(ggmap)
library(tidyverse)
library(patchwork)
library(janitor)
library(tibble)
```

```{r fig.width=7, fig.height=5}
#df <- read.csv("/Users/saikrupa/Desktop/projects_in_R/data/vegetarian_restaurants_US_datafiniti.csv")
# "/Users/saikrupa/Desktop/projects_in_R/data/Datafiniti_Vegetarian_and_Vegan_Restaurants.csv"
df <- read.csv('project_data/Datafiniti_Vegetarian_and_Vegan_Restaurants.csv')
dat <- df %>% mutate_all(na_if,"")
vis_miss(dat, sort_miss = TRUE, warn_large_data = FALSE) +
  labs(title = "") +
  xlab("")
```
Observations:

- 38.3% of all observations in the data are missing while 61.7% of the observations in the data are present.
```{r}
colSums(is.na(dat)) %>% sort(decreasing = TRUE)
```

```{r}
x <- missing_data.frame(dat)
image(x = x)
#summary(x@patterns)
```
Observations:

- All of the missing observations observed are from 12 main variables as presented from the map above. 

```{r}
#summary(x@patterns)
```

#### Missing by borough
```{r}
df_b <- dat %>% 
  mutate(Borough = city)
percent_missing <- df_b %>% 
  group_by(Borough) %>% 
  summarize(num_restaurants = n(), num_na_claimed = sum(is.na(`claimed`))) %>% 
  mutate(percent_na = round(num_na_claimed/num_restaurants, 2)) %>% 
  arrange(-percent_na)
```
```{r}
df_b <- dat %>% 
  mutate(Borough = city)
percent_missing <- df_b %>% 
  group_by(Borough) %>% 
  summarize(num_restaurants = n(), num_na_menus_currency = sum(is.na(`menus.currency`))) %>%
  mutate(percent_na = round(num_na_menus_currency/num_restaurants, 2)) %>% arrange(-percent_na)
```

#### Number missing by city

```{r}
missing_counts <- dat %>% group_by(city) %>% summarise_all(~sum(is.na(.))) %>% transmute(city, sumNA = rowSums(.[-1]))
```

```{r fig.width=15, fig.height=20}
ggplot(data=missing_counts, aes(x=fct_reorder(city,-sumNA), y=sumNA)) + 
  geom_bar(stat="identity", color="blue", fill="lightblue") + 
  xlab("City") +
  ylab("Missing count") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 25), axis.text.y = element_text(vjust = 0.5, hjust=1, size = 25), axis.title.y =element_text(size = 25), axis.title.x =      element_text(size = 25))
```
Observations:

- We examined missing data by city, and interestingly enough, the majority of the missing data counts are those from New York City. 

- Observations from Brooklyn have the second highest number of missing data. 

#### Function for examining missing data 

```{r fig.size=20}
data.missing <- function(df, percent = 'FALSE'){
  
  missing_patterns <- data.frame(is.na(df)) %>%
  group_by_all() %>%
  count(name = "count", sort = TRUE) %>%
  ungroup()
  if(percent){
  missing_patterns$count = missing_patterns$count*100/nrow(df)
  }
  # Creating New missing patterns dataframe using the old one, this turns the TRUE/FALSE missing data into 1's and 0s. The adorn_totals("col") makes it so that a toal column for the sum of missing patterns in each row is appended to the entire dataframe. 

missing_patterns_new<- missing_patterns %>% mutate_all((as.integer)) %>% adorn_totals("col")

# Creates the pattern identiication. Appends a column called pattern_id that assigns a 0, 0,5, or 1 given the total number missing patterns - the count of missing patterns for each row. This will help in the colors of the overall map
missing_patterns_new <- missing_patterns_new %>%
  mutate(pattern_id=ifelse(missing_patterns_new$Total-missing_patterns_new$count==0,1,0.5))

#Creates a first identification column for each number of rows. there are 9 rows
# This is the final dataframe needed for the entire map
missing_patterns_new <- missing_patterns_new %>% rownames_to_column("id1")
missing_patterns_new$id1 <- as.factor(as.integer(missing_patterns_new$id1))

if(percent){
  missing_patterns$count = missing_patterns$count*100/nrow(df)
  p1 <- ggplot(data=missing_patterns_new,aes(x=fct_rev(reorder(id,1-count)),y=count)) + 
              geom_bar(aes(alpha=factor(missing_patterns_new$pattern_id)),stat = 'identity',fill = "#03b1fc") + 
              
              xlab("") + ylab("% rows") +
              ylim(0,100) + 
              scale_alpha_manual(values = c("0.5"=0.5,"1.0"=1), guide="none") +
              theme(axis.title.y=element_blank(), legend.position = "none") + 
              coord_flip() +
     theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 20), axis.text.y = element_text(vjust = 0.5, hjust=1, size = 20), axis.title.y
          =element_text(size = 20), axis.title.x =      element_text(size = 20))
}
else
{
p1 <- ggplot(data=missing_patterns_new,aes(x=fct_rev(reorder(id1,-count)),y=count)) + 
              geom_bar(aes(alpha=factor(missing_patterns_new$pattern_id)),stat = 'identity',fill = "#03b1fc") + 
              xlab("") + ylab("row count") +
              scale_alpha_manual(values = c("0.5"=0.5,"1.0"=1), guide="none") +
              theme(axis.title.y=element_blank(), legend.position = "none") + 
              coord_flip() + 
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 20), axis.text.y = element_text(vjust = 0.5, hjust=1, size = 20), axis.title.y
          =element_text(size = 20), axis.title.x =      element_text(size = 20))
}
    

complete_case_id <- missing_patterns_new %>% 
  filter(pattern_id == 1) %>% 
  select(id1) %>% 
  as.character()

missing_col <- df %>% select(everything()) %>%
  summarise_all(funs(sum(is.na(.))))


miss_col <- data.frame(col=names(missing_col))

f <- c(missing_col[1,])

miss_col$count <- as.integer(unlist(f))

miss_col <- miss_col[order(-miss_col$count),]

rownames(miss_col) <- 1:nrow(miss_col)

miss_col <- miss_col %>% mutate(col = fct_reorder(col, desc(count)))

if(percent){
  miss_col$count = miss_col$count*100/nrow(df)
  p2 <- ggplot(data= miss_col, aes(x=col,y=count)) + 
  geom_bar(stat = 'identity', fill = "#03b1fc", alpha=0.5) +
  scale_x_discrete(label=function(x) abbreviate(x, minlength = 3)) +
  xlab("") +
  ylim(0,100) + 
  ylab("% rows missing") +
     theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 20), axis.text.y = element_text(vjust = 0.5, hjust=1, size = 20), axis.title.y
          =element_text(size = 20), axis.title.x =      element_text(size = 20))
}
else{
p2 <- ggplot(data= miss_col, aes(x=col,y=count)) + 
  geom_bar(stat = 'identity', fill = "#03b1fc", alpha=0.5) +
  scale_x_discrete(label=function(x) abbreviate(x, minlength = 3)) +
  xlab("") +
  ylab("num rows missing") + 
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 20), axis.text.y = element_text(vjust = 0.5, hjust=1, size = 20), axis.title.y
          =element_text(size = 20), axis.title.x =      element_text(size = 20))
}

missing_map <- data.frame(is.na(df)) %>% 
  group_by_all() %>%
  count(name = "count", sort = TRUE) %>%
  ungroup()

missing_map <- subset(missing_map, select = -c(count))

tidycars <- missing_map %>% 
  rownames_to_column("id1") %>% 
  gather(key, value, -id1) %>% #gather key and value except id
  mutate(missing = ifelse(value==1, "yes", "no"))

tidycars <- tidycars %>% mutate(miss2=ifelse(missing=="yes",1,0))

tidycars$miss3 <- as.factor(ifelse(tidycars$id1 == complete_case_id,0.5,tidycars$miss2))

tidycars$key <- factor(tidycars$key, levels = levels(miss_col$col))
tidycars$id1 <- factor(tidycars$id1, levels = levels(missing_patterns_new$id))

if(complete_case_id == 0) {
g <- ggplot(tidycars, aes(x = key, y = fct_rev(id1), fill = miss3)) +
      geom_tile(color = "white") +
      #scale_fill_brewer(palette = "Blues") +
      scale_fill_manual(values=c("#cacaca","#b2a0e1","darkgray")) +
      scale_x_discrete(label=function(x) abbreviate(x, minlength = 3)) +
      xlab("variable") +
      ylab("missing data pattern") +
      #theme(legend.position = "none") + 
  theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 20), axis.text.y = element_text(vjust = 0.5, hjust=1, size = 20), axis.title.y=element_text(size = 20), axis.title.x =      element_text(size = 20)) +
   annotate("text", x=length(unique(tidycars$key))/2, y=complete_case_id, label="complete cases")
}

else{
  g <- ggplot(tidycars, aes(x = key, y = fct_rev(id1), fill = miss3)) +
      geom_tile(color = "white") +
      #scale_fill_brewer(palette = "Blues") +
      scale_fill_manual(values=c("#cacaca","#b2a0e1","darkgray")) +
      scale_x_discrete(label=function(x) abbreviate(x, minlength = 3)) +
      xlab("variable") +
      ylab("missing data pattern") +
      #theme(legend.position = "none") + 
  theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 20), axis.text.y = element_text(vjust = 0.5, hjust=1, size = 20), axis.title.y=element_text(size = 20), axis.title.x =      element_text(size = 20))
  
}

p2 + plot_spacer() + g + p1 + plot_layout(widths = c(4,1), heights = c(1,3))

}
```

#### Applying data.missing function to data

```{r fig.width=20, fig.height=15}

data.missing(df, percent = FALSE)

```

```{r fig.width=20, fig.height=15}

data.missing(df, percent = TRUE)

```
Observations:

- Based on the resulting maps of missing data, we can note there may be a possibility of there being correlations between the first 9 variables listed on the map, as these variables all seem to have missing data within the same rows. 

- 100% of the data within these rows also appear to be missing.

- The first missing data pattern displayed on the map accounts for just over 60% of the rows in the data

- The second missing data pattern displayed on the map accounts for just over 35% of the rows of the data

- There are no complete cases of no missing data within this dataset.



<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results
```{r}
library(dplyr)
library(ggplot2)
library(forcats)
library(ggmap)
library(tidyverse)
library(choroplethr)
library(vcd)
```

```{r fig.height=10, fig.width=10}
df <- read_csv('project_data/inconvience_reasons.csv')
tidydf <- df %>%
     gather(key = "opinion", value = "Counts", "Disagree", "Agree", "Neither agree nor disagree")
ggplot(
      tidydf,
      aes(Counts, 
          fct_reorder2(reason, opinion=="Disagree", Counts, .desc = FALSE),
          color = opinion)) +
      geom_point(aes(size=1)) + 
      ggtitle("Inconvience Reasons") + 
      ylab("") 
```

Number of restuarants in each region
```{r fig.height=10, fig.width=10}
df_state <- read.csv("project_data/states_grouped_1.csv")
state_choropleth(df_state, title = "Number of Vegetarian restaurants in every state", legend="Counts") + scale_fill_brewer(palette=2)
```


How many vegetarian restuarants are opened from 2014-2018

```{r}
df <- read_csv('project_data/timeseries_opening_of_restuarants.csv')
df <- df[order(df$date),]
df$tmp <- "-01"
df$date <- paste0(df$date,df$tmp)
df$date <- as.Date(df$date, format="%Y-%m-%d")
df = df[-1,]
plot5 <- ggplot(df, aes(date, counts, group = 1)) +
         geom_point(color="black") + 
         geom_line(colour="black") +
         geom_smooth(method ="loess",span = .3,se=FALSE, color="darkgreen") +
         scale_x_date(date_breaks = "3 month", date_labels = "%b %y") +
         labs(x = "Date", y = "Number of Vegetarain restaurants", title = "Number of Vegetarian restaurants opened over time")
plot5
```

```{r fig.height=10, fig.width=10}
df <- read_csv("project_data/age_transition_legth.csv")
df$ALLTRANSITION <- as.integer(df$ALLTRANSITION)
df$ALLLENGTH <- as.integer(df$ALLLENGTH)
mosaic(ALLTRANSITION ~ ALLLENGTH, df, direction=c("v","h"),main='Mosaic plot for Length and Transition')
```


```{r}
df <- read_csv("project_data/age_difficulty_during_transition.csv")
df <- df[c("Age","difficulty_during_transition")]
df$difficulty_during_transition <- as.factor(df$difficulty_during_transition)
ggplot(df, aes(fct_infreq(difficulty_during_transition))) +
  geom_bar(color="darkgreen",fill = "palegreen3") + 
  ggtitle("What age group is facing a lot of difficulty during transition") +
  xlab("Opinion")+
  ylab("Count")+
  facet_wrap('Age') +
  theme_grey(14) + 
  theme(text = element_text(size=9), legend.position = "none", plot.title = element_text(hjust = 0.5))
```

```{r}
df_inc <- read_csv("project_data/age_difficulty_during_transition.csv")
df_inc
df_inc_1 <- read_csv('project_data/inconvience_reasons.csv')
```

```{r}
df_trans <- read_csv("project_data/age_transition_legth.csv")
df_trans
```

```{r}
sapply(df_trans, class)
```


```{r}
df_trans$ALLTRANSITION <- as.factor(df_trans$ALLTRANSITION)
```
```{r}
df_trans$ALLTRANSITION <- as.factor(df_trans$ALLTRANSITION)
ggplot(df_trans, aes(x=ALLAGEADOPTION, y=ALLTRANSITION)) + geom_boxplot() + theme_grey(16) + ggtitle(" Summary of loan amounts for each level of loan purpose") + xlab("Age")  + ylab("How Long before Fully Transitioned After Deciding") + theme(text = element_text(size=9), legend.position = "none")
```

```{r}
df_trans$ALLLENGTH <- as.factor(df_trans$ALLLENGTH)
ggplot(df_trans, aes(x=ALLAGEADOPTION, y=ALLLENGTH)) + geom_boxplot() + theme_grey(16) + ggtitle(" Summary of loan amounts for each level of loan purpose") + xlab("Age")  + ylab("Length of Diet") + theme(text = element_text(size=9), legend.position = "none")
```

```{r}
df_veg_reasons <- read_csv("project_data/reasons_for_veganism.csv")
df_veg_reasons
```

```{r}
df_veg_merged <- merge(df_trans, df_veg_reasons, by = "id")
df_veg_merged
```

```{r}
chosen_cols <- c("ALLTRANSITION","ALLLENGTH", "ALLANIMALPROTECTION",
                 "ALLENVIRONMENT", "ALLCOST","ALLHEALTH",
                 "ALLRELIGIOUSSPIRITUAL", "ALLSOCIALINFLUENCE",
                 "ALLSOCIALJUSTICEWORLDHUNGER", "ALLFOODTREND",
                 "ALLDISGUST")
df_veg_merged[chosen_cols] <- lapply(df_veg_merged[chosen_cols], factor)
                 
#df_pivoted <- df_veg_merged %>%
  #pivot_longer(everything(), manes_to = "")
ggplot(df_veg_merged, aes(x=ALLTRANSITION)) +
  geom_bar(color="darkgreen",fill = "palegreen3") + 
  ggtitle("Length to Transition vs. Length of Overall Diet") +
  xlab("How Long Partitipants took to Transition")+
  ylab("Count")+
  facet_wrap('ALLLENGTH') +
  theme_grey(14) + 
  theme(text = element_text(size=9), legend.position = "none", plot.title = element_text(hjust = 0.5))
```


```{r}
df_incondichot <- read_csv('project_data/inconvenience_dichot.csv')
df_incondichot


df_incondichot$ALLINCONVENIENCE4D <- as.factor(df_incondichot$ALLINCONVENIENCE4D)
df_incondichot$ALLLENGTH <- as.integer(df_incondichot$ALLLENGTH)
mosaic(ALLLENGTH~ALLINCONVENIENCE4D, df_incondichot, direction=c("v","h"),main='Length of Diet & Difficulty Accessing Health Foods')
```

```{r}
df_incondichot$ALLINCONVENIENCE3D <- as.factor(df_incondichot$ALLINCONVENIENCE3D)
mosaic(ALLLENGTH~ALLINCONVENIENCE3D, df_incondichot, direction=c("v","h"),main='Length of Diet & Trouble Finding Restaurants')
```

<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component


<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

